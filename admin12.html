<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة تحكم الأطباء - المدير</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to right, #dfe9f3, #ffffff);
            padding: 20px;
            direction: rtl;
        }
        h1 {
            text-align: center;
            color: #0077b6;
        }
        input, select, button, textarea {
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        textarea {
            resize: none;
        }
        button {
            cursor: pointer;
            background-color: #00b4d8;
            color: white;
            border: none;
        }
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .doctor-card {
            background: #e0f7fa;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px 20px;
            width: 280px;
            box-sizing: border-box;
            direction: rtl;
            text-align: right;
        }
        .doctor-card p {
            margin: 8px 0;
            font-size: 14px;
        }
        .doctor-card button {
            margin: 5px 5px 0 0;
            padding: 7px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .doctor-card button:first-of-type {
            background-color: #0288d1;
            color: white;
        }
        .doctor-card button:last-of-type {
            background-color: #d32f2f;
            color: white;
        }
        #search {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>صفحة مدير الأطباء</h1>
    <div id="formSection">
        <input type="hidden" id="doctorId" />
        <input type="text" id="name" placeholder="اسم الطبيب" />
        <select id="specialty">
            <option value="" disabled selected>اختر التخصص</option>
            <option>الأنف و الأذن و الحنجرة</option>
            <option>الأسنان</option>
            <option>القلبية</option>
            <option>الأطفال</option>
            <option>الباطنية</option>
            <option>النسائية والتوليد</option>
            <option>النفسية</option>
            <option>جراحة عامة</option>
            <option>الجلدية</option>
            <option>الجملة العصبية</option>
            <option>العظام والمفاصل</option>
            <option>البولية</option>
            <option>العيون</option>
            <option>الأورام</option>
            <option>التخدير</option>
            <option>التجميلية</option>
            <option>الأسرة و المجتمع</option>
            <option>الفسلجة</option>
            <option>التغذية</option>
            <option>العلاج الطبيعي</option>
            <option>الأشعة التشخيصية</option>
        </select>
        <input type="text" id="address" placeholder="العنوان" />
        <input type="tel" id="phone" placeholder="رقم الحجز" inputmode="numeric" pattern="[0-9]*" />
        <input type="text" id="holiday" placeholder="عطلة العيادة" />
        <input type="date" id="hide_date" placeholder="تاريخ الإخفاء" />
        <input type="text" id="map" placeholder="رابط الخريطة" />
        <textarea id="notes" rows="2" placeholder="ملاحظات (اختياري)"></textarea> <br/>
        <button onclick="addDoctor()">➕ إضافة طبيب</button>
        <button onclick="updateDoctor()">✏️ تعديل الطبيب</button>
    </div>
    <br/>
    <input type="text" id="search" placeholder="🔍 ابحث باسم أو تخصص أو عنوان" onkeyup="filterTable()"/>
    <div id="doctorCards" class="cards-container"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz2GXZJjYA6SBqVrl63wEEMZuE6Y71OFXWq6O1oljv9CMzw1IdM2sNAuy3YWPmxhQPl/exec';
        let doctors = [];

        async function loadDoctors() {
            try {
                const res = await fetch(`${API_URL}?action=getSheetData`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                doctors = await res.json();
                displayDoctorsManager();
            } catch (error) {
                console.error("Failed to load doctors:", error);
                alert("فشل في تحميل البيانات. يرجى التأكد من رابط API.");
            }
        }

        function displayDoctorsManager() {
            const container = document.getElementById('doctorCards');
            container.innerHTML = '';
            const today = new Date();
            const reversedDoctors = [...doctors].reverse();

            reversedDoctors.forEach((doc, index) => {
                let hideDateColor = '';
                if (doc.hide_date) {
                    const hideDate = new Date(doc.hide_date);
                    const diffDays = Math.ceil((hideDate - today) / (1000 * 60 * 60 * 24));
                    if (hideDate < today) {
                        hideDateColor = 'background-color: #f8d7da;';
                    } else if (diffDays <= 3) {
                        hideDateColor = 'background-color: #fff3cd;';
                    }
                }

                const card = document.createElement('div');
                card.className = 'doctor-card';
                card.setAttribute('style', hideDateColor);

                card.innerHTML = `
                    <p><strong>الرقم:</strong> ${doc.id}</p>
                    <p style="color:#005792; font-weight:bold; font-size:16px;"><strong>الاسم:</strong> ${doc.name}</p>
                    <p><strong>التخصص:</strong> ${doc.specialty}</p>
                    <p><strong>العنوان:</strong> ${doc.address}</p>
                    <p><strong>الهاتف:</strong> ${doc.phone}</p>
                    <p><strong>العطلة:</strong> ${doc.holiday}</p>
                    <p><strong>تاريخ الإخفاء:</strong> ${doc.hide_date}</p>
                    <p><strong>رابط الخريطة:</strong> <a href="${doc.map}" target="_blank">فتح الخريطة</a></p>
                    <p><strong>ملاحظات:</strong> ${doc.notes || ''}</p>
                    <button onclick="fillForm(${doctors.length - 1 - index})">✏️ تعديل</button>
                    <button onclick="deleteDoctor('${doc.id}')">🗑️ حذف</button>
                `;
                container.appendChild(card);
            });
        }

        function fillForm(index) {
            const doc = doctors[index];
            document.getElementById('doctorId').value = doc.id;
            document.getElementById('name').value = doc.name;
            document.getElementById('specialty').value = doc.specialty || "";
            document.getElementById('address').value = doc.address;
            document.getElementById('phone').value = doc.phone;
            document.getElementById('holiday').value = doc.holiday;
            
            // تعديل هذا السطر لتنسيق التاريخ
            if (doc.hide_date) {
                const date = new Date(doc.hide_date);
                const formattedDate = date.toISOString().split('T')[0];
                document.getElementById('hide_date').value = formattedDate;
            } else {
                document.getElementById('hide_date').value = '';
            }
            
            document.getElementById('map').value = doc.map || '';
            document.getElementById('notes').value = doc.notes || '';
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
        }

        function getFormData() {
            return {
                name: document.getElementById('name').value,
                specialty: document.getElementById('specialty').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                holiday: document.getElementById('holiday').value,
                hide_date: document.getElementById('hide_date').value,
                map: document.getElementById('map').value,
                notes: document.getElementById('notes').value
            };
        }

        async function addDoctor() {
            const rowData = getFormData();
            if (!rowData.name) {
                alert("يرجى إدخال اسم الطبيب.");
                return;
            }
            const dataToSend = {
                action: 'addRow',
                rowData: rowData
            };
            await sendData(dataToSend);
        }

        async function updateDoctor() {
            const id = document.getElementById('doctorId').value;
            if (!id) {
                alert('يرجى اختيار طبيب للتعديل.');
                return;
            }
            const rowData = getFormData();
            const dataToSend = {
                action: 'updateRow',
                id: id,
                rowData: rowData
            };
            await sendData(dataToSend);
        }

        async function deleteDoctor(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الطبيب؟')) return;
            const dataToSend = {
                action: 'deleteRow',
                id: id
            };
            await sendData(dataToSend);
        }

        async function sendData(data) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const result = await res.text();
                alert(result);
                loadDoctors();
                clearForm();
            } catch (error) {
                console.error("Failed to send data:", error);
                alert("حدث خطأ أثناء الاتصال بالخادم.");
            }
        }
        
        function clearForm() {
            document.querySelectorAll('input, textarea').forEach(input => input.value = '');
            document.getElementById('specialty').value = "";
            document.getElementById('doctorId').value = '';
        }

        function normalizeArabic(text) {
            return text
                .replace(/[\u064B-\u0652]/g, '')
                .replace(/[أإآ]/g, 'ا')
                .replace(/ؤ/g, 'و')
                .replace(/ئ/g, 'ي')
                .replace(/ة/g, 'ه')
                .replace(/ى/g, 'ي');
        }

        function filterTable() {
            const query = normalizeArabic(document.getElementById('search').value.toLowerCase());
            const cards = document.querySelectorAll('.doctor-card');
            cards.forEach(card => {
                const text = normalizeArabic(card.innerText.toLowerCase());
                card.style.display = text.includes(query) ? '' : 'none';
            });
        }

        loadDoctors();
    </script>
</body>
</html>
