<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ - Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to right, #dfe9f3, #ffffff);
            padding: 20px;
            direction: rtl;
        }
        h1 {
            text-align: center;
            color: #0077b6;
        }
        input, select, button, textarea {
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        textarea {
            resize: none;
        }
        button {
            cursor: pointer;
            background-color: #00b4d8;
            color: white;
            border: none;
        }
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .doctor-card {
            background: #e0f7fa;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px 20px;
            width: 280px;
            box-sizing: border-box;
            direction: rtl;
            text-align: right;
        }
        .doctor-card p {
            margin: 8px 0;
            font-size: 14px;
        }
        .doctor-card button {
            margin: 5px 5px 0 0;
            padding: 7px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .doctor-card button:first-of-type {
            background-color: #0288d1;
            color: white;
        }
        .doctor-card button:last-of-type {
            background-color: #d32f2f;
            color: white;
        }
        #search {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>ØµÙØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h1>
    <div id="formSection">
        <input type="hidden" id="doctorId" />
        <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" />
        <select id="specialty">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ</option>
            <option>Ø§Ù„Ø£Ù†Ù Ùˆ Ø§Ù„Ø£Ø°Ù† Ùˆ Ø§Ù„Ø­Ù†Ø¬Ø±Ø©</option>
            <option>Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
            <option>Ø§Ù„Ù‚Ù„Ø¨ÙŠØ©</option>
            <option>Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
            <option>Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ©</option>
            <option>Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ØªÙˆÙ„ÙŠØ¯</option>
            <option>Ø§Ù„Ù†ÙØ³ÙŠØ©</option>
            <option>Ø¬Ø±Ø§Ø­Ø© Ø¹Ø§Ù…Ø©</option>
            <option>Ø§Ù„Ø¬Ù„Ø¯ÙŠØ©</option>
            <option>Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¹ØµØ¨ÙŠØ©</option>
            <option>Ø§Ù„Ø¹Ø¸Ø§Ù… ÙˆØ§Ù„Ù…ÙØ§ØµÙ„</option>
            <option>Ø§Ù„Ø¨ÙˆÙ„ÙŠØ©</option>
            <option>Ø§Ù„Ø¹ÙŠÙˆÙ†</option>
            <option>Ø§Ù„Ø£ÙˆØ±Ø§Ù…</option>
            <option>Ø§Ù„ØªØ®Ø¯ÙŠØ±</option>
            <option>Ø§Ù„ØªØ¬Ù…ÙŠÙ„ÙŠØ©</option>
            <option>Ø§Ù„Ø£Ø³Ø±Ø© Ùˆ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</option>
            <option>Ø§Ù„ÙØ³Ù„Ø¬Ø©</option>
            <option>Ø§Ù„ØªØºØ°ÙŠØ©</option>
            <option>Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ</option>
            <option>Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„ØªØ´Ø®ÙŠØµÙŠØ©</option>
        </select>
        <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
        <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²" inputmode="numeric" pattern="[0-9]*" />
        <input type="text" id="holiday" placeholder="Ø¹Ø·Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" />
        <input type="date" id="hide_date" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø®ÙØ§Ø¡" />
        <input type="text" id="map" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©" />
        <textarea id="notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea> <br/>
        <button onclick="addDoctor()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨</button>
        <button onclick="updateDoctor()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ¨</button>
    </div>
    <br/>
    <input type="text" id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø£Ùˆ ØªØ®ØµØµ Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù†" onkeyup="filterTable()"/>
    <div id="doctorCards" class="cards-container"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz2GXZJjYA6SBqVrl63wEEMZuE6Y71OFXWq6O1oljv9CMzw1IdM2sNAuy3YWPmxhQPl/exec';
        let doctors = [];

        async function loadDoctors() {
            try {
                const res = await fetch(`${API_URL}?action=getSheetData`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                doctors = await res.json();
                displayDoctorsManager();
            } catch (error) {
                console.error("Failed to load doctors:", error);
                alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· API.");
            }
        }

        function displayDoctorsManager() {
            const container = document.getElementById('doctorCards');
            container.innerHTML = '';
            const today = new Date();
            const reversedDoctors = [...doctors].reverse();

            reversedDoctors.forEach((doc, index) => {
                let hideDateColor = '';
                if (doc.hide_date) {
                    const hideDate = new Date(doc.hide_date);
                    const diffDays = Math.ceil((hideDate - today) / (1000 * 60 * 60 * 24));
                    if (hideDate < today) {
                        hideDateColor = 'background-color: #f8d7da;';
                    } else if (diffDays <= 3) {
                        hideDateColor = 'background-color: #fff3cd;';
                    }
                }

                const card = document.createElement('div');
                card.className = 'doctor-card';
                card.setAttribute('style', hideDateColor);

                card.innerHTML = `
                    <p><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> ${doc.id}</p>
                    <p style="color:#005792; font-weight:bold; font-size:16px;"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${doc.name}</p>
                    <p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${doc.specialty}</p>
                    <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${doc.address}</p>
                    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${doc.phone}</p>
                    <p><strong>Ø§Ù„Ø¹Ø·Ù„Ø©:</strong> ${doc.holiday}</p>
                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø®ÙØ§Ø¡:</strong> ${doc.hide_date}</p>
                    <p><strong>Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©:</strong> <a href="${doc.map}" target="_blank">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></p>
                    <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${doc.notes || ''}</p>
                    <button onclick="fillForm(${doctors.length - 1 - index})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="deleteDoctor('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                `;
                container.appendChild(card);
            });
        }

        function fillForm(index) {
            const doc = doctors[index];
            document.getElementById('doctorId').value = doc.id;
            document.getElementById('name').value = doc.name;
            document.getElementById('specialty').value = doc.specialty || "";
            document.getElementById('address').value = doc.address;
            document.getElementById('phone').value = doc.phone;
            document.getElementById('holiday').value = doc.holiday;
            
            // ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            if (doc.hide_date) {
                const date = new Date(doc.hide_date);
                const formattedDate = date.toISOString().split('T')[0];
                document.getElementById('hide_date').value = formattedDate;
            } else {
                document.getElementById('hide_date').value = '';
            }
            
            document.getElementById('map').value = doc.map || '';
            document.getElementById('notes').value = doc.notes || '';
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
        }

        function getFormData() {
            return {
                name: document.getElementById('name').value,
                specialty: document.getElementById('specialty').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                holiday: document.getElementById('holiday').value,
                hide_date: document.getElementById('hide_date').value,
                map: document.getElementById('map').value,
                notes: document.getElementById('notes').value
            };
        }

        async function addDoctor() {
            const rowData = getFormData();
            if (!rowData.name) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨.");
                return;
            }
            const dataToSend = {
                action: 'addRow',
                rowData: rowData
            };
            await sendData(dataToSend);
        }

        async function updateDoctor() {
            const id = document.getElementById('doctorId').value;
            if (!id) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø¨ÙŠØ¨ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.');
                return;
            }
            const rowData = getFormData();
            const dataToSend = {
                action: 'updateRow',
                id: id,
                rowData: rowData
            };
            await sendData(dataToSend);
        }

        async function deleteDoctor(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŸ')) return;
            const dataToSend = {
                action: 'deleteRow',
                id: id
            };
            await sendData(dataToSend);
        }

        async function sendData(data) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const result = await res.text();
                alert(result);
                loadDoctors();
                clearForm();
            } catch (error) {
                console.error("Failed to send data:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
            }
        }
        
        function clearForm() {
            document.querySelectorAll('input, textarea').forEach(input => input.value = '');
            document.getElementById('specialty').value = "";
            document.getElementById('doctorId').value = '';
        }

        function normalizeArabic(text) {
            return text
                .replace(/[\u064B-\u0652]/g, '')
                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
                .replace(/Ø¤/g, 'Ùˆ')
                .replace(/Ø¦/g, 'ÙŠ')
                .replace(/Ø©/g, 'Ù‡')
                .replace(/Ù‰/g, 'ÙŠ');
        }

        function filterTable() {
            const query = normalizeArabic(document.getElementById('search').value.toLowerCase());
            const cards = document.querySelectorAll('.doctor-card');
            cards.forEach(card => {
                const text = normalizeArabic(card.innerText.toLowerCase());
                card.style.display = text.includes(query) ? '' : 'none';
            });
        }

        loadDoctors();
    </script>
</body>
</html>
